# 模块间通信协议文档

## 一、文档基本信息

| 项目     | 内容                                                         |
| -------- | ------------------------------------------------------------ |
| 文档版本 | V1.0                                                         |
| 适用场景 | CSGO 跨主机（A 主机决策 + B 主机运行）键鼠控制系统           |
| 核心目标 | 规范视频传输、图像识别、LLM 决策、CH9329 硬件四大模块的输入 / 输出格式，确保数据无缝对接 |
| 风险提示 | 仅适用于非竞技模式测试，避免触发 CSGO VAC 反作弊机制         |

## 二、视频传输模块（B→A 主机）

### 1. 通信目标

将 B 主机的 CSGO 画面实时传输至 A 主机，为图像识别模块提供稳定、低延迟的帧数据。

### 2. 支持方案及数据格式

| 传输方案                   | 输出数据格式                | 关键参数要求                                                 |
| -------------------------- | --------------------------- | ------------------------------------------------------------ |
| 硬件采集卡（如圆刚 GC553） | 原始 RGB 帧数据（无压缩）   | 分辨率：1280×720（推荐）/ 1920×1080；帧率：60fps；延迟≤50ms  |
| 软件流媒体（OBS+VLC）      | H.264 编码视频流（TS 封装） | 分辨率：1280×720；码率：5Mbps；帧率：60fps；延迟≤150ms；拉流地址格式：rtmp://[A 主机局域网 IP]:1935/live |

### 3. 数据交付方式

- 硬件采集卡：通过采集卡驱动 SDK（如圆刚 SDK），以回调函数形式向 A 主机图像识别模块推送 RGB 帧（数据类型：uint8_t [高度 × 宽度 ×3]）。
- 软件流媒体：A 主机 VLC 通过 “RTSP/RTMP 拉流接口” 获取视频流，解码后输出 RGB 帧，每帧携带时间戳（格式：YYYY-MM-DD HH:MM:SS:mmm）。

## 三、图像识别模块（A 主机内部）

### 1. 通信目标

从视频流帧中提取 “自身坐标” 和 “敌人信息”，为 LLM 决策模块提供结构化场景数据。

### 2. 输入格式

- 接收视频传输模块输出的 RGB 帧数据，需包含：
  - 帧数据：uint8_t [高度 × 宽度 ×3]（与视频传输模块分辨率一致）
  - 时间戳：YYYY-MM-DD HH:MM:SS:mmm（与视频帧一一对应）

### 3. 输出格式（JSON）

```json
{
  "frame_timestamp": "2024-05-20 14:30:00:123",
  "self_info": {
    "in_game_coordinate": "(X:123.4, Y:456.7)",  // 游戏内自身坐标（提取自UI）
    "weapon": "AK-47",  // 当前武器（可选，通过UI识别）
    "health": 100       // 自身血量（可选，通过UI识别）
  },
  "enemy_info": [
    {
      "enemy_id": 1,
      "pixel_coordinate": "(x1:300, y1:200, x2:350, y2:300)",  // 敌人在帧中的像素矩形
      "confidence": 0.92,  // 识别置信度（≥0.8视为有效）
      "relative_position": "正前方约50米"  // 相对自身位置（可选，基于像素坐标推算）
    },
    {
      "enemy_id": 2,
      "pixel_coordinate": "(x1:600, y1:220, x2:650, y2:320)",
      "confidence": 0.85,
      "relative_position": "右前方约30米"
    }
  ],
  "scene_info": "无烟雾、无障碍物"  // 场景补充信息（可选）
}
```

### 4. 数据交付方式

通过本地 TCP 端口（如 127.0.0.1:8080）向 LLM 决策模块推送 JSON 数据，推送频率与视频帧率一致（60 次 / 秒），无效数据（如无敌人、置信度＜0.8）需标记`"is_valid": false`。

## 四、LLM 决策模块（A 主机内部）

### 1. 通信目标

基于 MCP（大模型上下文协议）整合图像识别数据，调用 LLM 生成标准化键鼠操作指令，传递给 CH9329 硬件模块。

### 2. 输入格式

- 接收图像识别模块输出的 JSON 数据（需验证`is_valid: true`），同时加载固定游戏规则上下文（如 CSGO 操作逻辑）。

### 3. MCP 上下文格式（JSON，用于调用 LLM）

```json
{
  "protocol_version": "MCP V1.0",
  "context_sequence": [
    {
      "step": 1,
      "timestamp": "2024-05-20 14:30:00:123",
      "content": "自身状态：坐标(X:123.4,Y:456.7)，武器AK-47，血量100"
    },
    {
      "step": 2,
      "timestamp": "2024-05-20 14:30:00:123",
      "content": "敌人状态：共2个有效敌人，ID1在正前方50米（像素坐标300,200-350,300），ID2在右前方30米"
    },
    {
      "step": 3,
      "timestamp": "2024-05-20 14:30:00:123",
      "content": "场景约束：无烟雾、无障碍物，敌人未发现自身"
    }
  ],
  "instruction": "1. 遵循CSGO操作规则，优先攻击距离最近的敌人；2. 输出格式严格为JSON，仅含操作指令，无额外解释；3. 键鼠操作需包含「键盘按键」「鼠标动作」「执行延迟」三个字段"
}
```

### 4. 输出格式（标准化键鼠指令，JSON）

```json
{
  "instruction_id": "INS_20240520143000123",
  "timestamp": "2024-05-20 14:30:00:223",
  "keyboard": [
    {
      "action": "press",  // press（按下）/ release（松开）
      "key": "W",         // 支持键：W/S/A/D/空格（Jump）/LeftCtrl（Crouch）
      "delay": 0          // 相对于指令下发的延迟（单位：ms）
    }
  ],
  "mouse": [
    {
      "action": "move",   // move（移动）/ click（单击）/ press（长按）/ release（松开）
      "parameter": "(dx:50, dy:0)",  // move用(dx:X偏移, dy:Y偏移)，click无需参数
      "delay": 100        // 移动后延迟100ms执行点击
    },
    {
      "action": "click",
      "parameter": "left",  // left（左键，开枪）/ right（右键，特殊攻击）
      "delay": 200
    }
  ],
  "execution_timeout": 500  // 指令有效期（超过则废弃，单位：ms）
}
```

### 5. 数据交付方式

通过本地串口（如 COM3，与 CH9329 模块绑定）向 CH9329 硬件模块推送 JSON 指令，推送频率≤10 次 / 秒（避免指令堆积），指令需携带 CRC 校验码（`"crc32": "0x12345678"`）确保完整性。

## 五、CH9329 硬件模块（A→B 主机）

### 1. 通信目标

将 LLM 决策模块的标准化指令转换为 USB-HID 协议信号，模拟物理键鼠操作，发送至 B 主机。

### 2. 输入格式

- 接收 LLM 决策模块输出的 JSON 指令（需验证 CRC 校验和`execution_timeout`），仅处理有效期内的指令。

### 3. HID 指令编码规则

CH9329 支持 “键盘报告” 和 “鼠标报告” 两种 HID 格式，需将 JSON 指令转换为对应的字节数组（参考 CH9329 datasheet）。

| 操作类型                | HID 报告格式（字节数组）                                     | 说明                                                         |
| ----------------------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| 键盘按下（W 键）        | [0x00, 0x00, 0x1A, 0x00, 0x00, 0x00, 0x00, 0x00]             | 第 3 字节为键扫描码（W=0x1A，S=0x16，A=0x04，D=0x07，空格 = 0x2C） |
| 键盘松开（W 键）        | [0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00]             | 所有按键松开时，第 3 字节设为 0x00                           |
| 鼠标移动（dx=50, dy=0） | [0x00, 0x32, 0x00, 0x00, 0x00]                               | 第 1 字节：按键状态（0 = 无按键）；第 2 字节：X 轴偏移（50=0x32）；第 3 字节：Y 轴偏移（0=0x00） |
| 鼠标左键单击            | [0x01, 0x00, 0x00, 0x00, 0x00] → [0x00, 0x00, 0x00, 0x00, 0x00] | 先发送 “按下”（第 1 字节 = 0x01），延迟 50ms 发送 “松开”（第 1 字节 = 0x00） |

### 4. 数据交付方式

- 硬件连接：CH9329 的 USB_HOST 口接 B 主机（模拟键鼠），USB_DEVICE 口接 A 主机（接收指令）。
- 软件通信：A 主机通过 PySerial 库（波特率 115200，数据位 8，停止位 1，无校验）向 CH9329 发送编码后的 HID 字节数组，发送后等待模块返回 “ACK”（0x06）确认接收。

## 六、模块联动时序

1. 视频传输模块每 16.7ms（60fps）向图像识别模块推送 1 帧 RGB 数据。
2. 图像识别模块接收帧后，5ms 内完成识别并输出 JSON 数据至 LLM 决策模块。
3. LLM 决策模块接收数据后，100ms 内完成 MCP 上下文封装、LLM 调用、指令生成，输出至 CH9329 模块。
4. CH9329 模块接收指令后，20ms 内完成 HID 编码并发送至 B 主机，执行键鼠操作。
5. 整体延迟控制目标：≤200ms（视频 50ms + 识别 5ms + 决策 100ms + 硬件 20ms + 其他 25ms）。